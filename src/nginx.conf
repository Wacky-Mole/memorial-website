# Nginx security snippets for memorial-website
# Place the relevant parts inside your server { } block or include this file.
# These rules are examples â€” adapt paths and root directives to match your deployment.

# 1) Basic hardening (put inside server { ... })
# Disable directory listing and set security headers
location / {
    autoindex off;
    # try_files $uri $uri/ =404;  # enable if you want strict file handling
}

# Deny access to hidden files (dotfiles) and git
location ~ (^|/)\.[^/]+ {
    return 404;
}

# Deny direct access to database files, logs and config
location ~* /(?:data|src)/.*\.(?:db|sqlite|log|env|sql)$ {
    return 403;
}

# Alternatively, deny access to the data directory entirely
location /data/ {
    internal;
    deny all;
}

# Security headers (if using add_header)
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "same-origin" always;
# Consider enabling HSTS in production (requires HTTPS):
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# 2) Uploads directory: prevent execution of scripts and restrict access
# Place this inside server { } and ensure the path matches your uploads location
location ^~ /uploads/ {
    # Serve static files only. Do not interpret as scripts.
    autoindex off;

    # Deny access to potentially executable file types
    location ~* \.(?:php|php5|phtml|pl|py|jsp|asp|aspx|sh|cgi|exe|bat)$ {
        deny all;
        return 403;
    }

    # Deny dotfiles inside uploads
    location ~ (^|/)\.[^/]+ {
        return 404;
    }

    # Serve images normally
    try_files $uri $uri/ =404;
}

# 3) If you store sensitive files outside webroot, serve via an access script
# Example protected file access (not enabled by default):
# location /protected/ {
#     internal;
#     alias /var/www/memorial/data/;    # actual location outside webroot
# }

# Notes:
# - Test config with: nginx -t
# - Reload nginx after changes: systemctl reload nginx
# - On some hosting providers, you will need to adjust paths (root) and possibly put parts in the http block or server block.
# - These are defensive rules; ensure other server-level restrictions (chroot, user permissions) are also configured.
